<style>
  #page {
    min-height: 600px;
  }
  #contentContainer {
    padding-top: 20px;
  }
  #currentWorkoutButtonContainer {
    padding-top: 10px;
  }
  #currentWorkoutButtonContainer button {
        width: -webkit-fill-available;
  }
  #currentWorkoutTab {
    display: none;
  }
</style>

<input id="planId" name="planId" type="hidden" value="{collection.urlId}">

<ul id="topNavTabs" class="nav nav-tabs">
  <li id="currentWorkoutTab" class="nav-item">
    <a class="nav-link" href="#">This Week</a>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Off-Season<span class="caret"></span></a>
    <div class="dropdown-menu" id="offseasonMenu"></div>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Pre-Season<span class="caret"></span></a>
    <div class="dropdown-menu" id="preseasonMenu"></div>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">In-Season<span class="caret"></span></a>
    <div class="dropdown-menu" id="inseasonMenu"></div>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Post-Season<span class="caret"></span></a>
    <div class="dropdown-menu" id="postseasonMenu"></div>
  </li>
</ul>
<div id="currentWorkoutButtonContainer"></div>
<div id="contentContainer"></div>

<script type="text/javascript">

  // Load all images via Squarespace's Responsive ImageLoader
  function loadAllImages() {
    var images = document.querySelectorAll('img[data-src]' );
    for (var i = 0; i < images.length; i++) {
      ImageLoader.load(images[i], {load: true});
    }
  }

  function displayContent( content ){
    $("#contentContainer").html(content);
    loadAllImages();
  };

  function displayWorkout(data, season, weekNumber){

    var workoutBody = "<div>Error: the workout for this week is currently not available.</div>";

    $(data.items).each(function(){
      var thisSeason  = this.customContent.season.toLowerCase();
      var thisGender  = this.customContent.gender.toLowerCase();
      var thisLevel   = this.customContent.level.toLowerCase();
      if (  
        thisSeason                    == season      && 
        this.customContent.weekNumber == weekNumber  && 
        thisGender                    == gender      && 
        thisLevel                     == level       && 
        this.customContent.planId     == planId 
      ){ 
        workoutBody = this.body; 
        return false; 
      } else if (
        thisSeason                    == season      && 
        this.customContent.weekNumber == weekNumber  && 
        thisGender                    == gender      && 
        thisLevel                     == level       && 
        (this.customContent.planId == undefined || this.customContent.planId == "") 
      ){ 
        workoutBody = this.body; 
        return false; 
      }
    });
    $("#contentContainer").html($(workoutBody).html()); 
    loadAllImages();
  };

  function createSeasonMenus( workoutsList ){
    $(workoutsList).each(function(index){
      var link = $("<a>");

      link.attr( "href",  "#" );
      link.attr( "class", "dropdown-item" );
      link.html( "Week " + this.weekNumber );

      link.data( "season",      this.season.toUpperCase() );
      link.data( "weekNumber",  this.weekNumber );
      link.data( "workoutId",   index)

      var seasonMenu;
      switch ( this.season.toUpperCase() ) {
        case "OFF":
          seasonMenu = $("#offseasonMenu");
          break;
        case "PRE":
          seasonMenu = $("#preseasonMenu");
          break;
        case "IN":
          seasonMenu = $("#inseasonMenu");
          break;
        case "POST":
          seasonMenu = $("#postseasonMenu");
          break;
      }

      seasonMenu.append(link);

      $(seasonMenu).children("a").sort(sort_menu).appendTo(seasonMenu);
      function sort_menu(a, b) {
        return ($(b).data("weekNumber")) < ($(a).data("weekNumber")) ? 1 : -1;
      };
    });
  };

  function clearSideNavActiveLink(){
    $(".sectionLinkContainer").each(function(){
      $(this).removeClass("active-link");
    });
  };

  function clearDropdownActiveLink(){
    $(".dropdown-item").each(function(){
      $(this).removeClass("active");
    });
  };

  function clearTabActiveLink(){
    $(".nav-link").each(function(){
      $(this).removeClass("active");
    });
  };

  function clearActive(){
    clearSideNavActiveLink();
    clearDropdownActiveLink();
    clearTabActiveLink();
  };

  function addSideNavListeners(){

    $(".sectionLink").each(function(){
      $(this).click(function(event) {
        event.preventDefault();

        clearActive();
        var parentContainer = $(this).parent()[0];
        $(parentContainer).addClass("active-link");

        $("#contentContainer").html("LOADING");

        var sectionLinkSlug = $(this).data("href");
        var url = "https://www.welllifewellness.com" + sectionLinkSlug;

        $.ajax({
          url: url, 
          data: {format:"json"}, 
          dataType: "json", 
          method: "GET"
        })
        .done(
          function(data){
            $("#contentContainer").html($(data.mainContent).html());
            loadAllImages();
          }
        );

      });
    });
  };

  function addCurrentWeekListener(){
    $("#currentWorkoutTab .nav-link").click(function(event){
      event.preventDefault();

      clearActive();
      $(this).addClass("active");

      ajaxRequestWorkouts( currentSeason, currentWeekNumber );

    })
    $("#currentWorkoutTab").show();
  }

  function addDropdownListeners(){

    $("#topNavTabs .nav-item .dropdown-menu .dropdown-item").each(function(){

      $(this).click(function(event) {

        event.preventDefault(); 

        clearActive();
        $(this).addClass("active");
        $($($(this).parent()[0]).siblings(".nav-link.dropdown-toggle")[0]).addClass("active");

        var seasonClicked = $(this).data("season").toLowerCase();
        var weekNumberClicked = $(this).data("weekNumber");
        var workoutIdClicked = $(this).data("workoutId");
        console.log(seasonClicked);
        console.log(weekNumberClicked);
        console.log(workoutIdClicked);
        
        displayContent(clientWorkouts[workoutIdClicked].content);

      });
    });

  };

  function ajaxRequestWorkouts( season, week ){
    var url = "https://www.welllifewellness.com/workouts";
    $.ajax({
      url: url, 
      data: {format:"json"}, 
      dataType: "json", 
      method: "GET"
    })
    .done(
      function(data){
        displayWorkout(data, season, week);          
      }
    );
  }

  function constructCurrentWorkoutButton(){
    if (currentSeason != undefined && currentWeekNumber != undefined){
      var currentWorkoutButton = $("<button>", {
        text : "Click Here to go to your Current Workout",
        id : "currentWorkoutButton",
        type : "button",
        class : "btn btn-primary"
      });
      $(currentWorkoutButton).click(function(event){
        ajaxRequestWorkouts( currentSeason, currentWeekNumber )
      });
      $("#currentWorkoutButtonContainer").append(currentWorkoutButton);
    }
  }

  function getClientPlanInfo(){
    $.ajax({
      url: "https://www.welllifewellness.com/plans", 
      data: {format:"json"}, 
      dataType: "json", 
      method: "GET"
    })
    .done(
      function(data){ 
        $(data.items).each(function(){
          if ( this.customContent.planId == planId ){
            gender =            this.customContent.gender.toLowerCase();
            level =             this.customContent.level.toLowerCase();
            clientFullName =    this.customContent.clientFullName;
            if ( this.customContent.currentSeason != "" ){      currentSeason =     this.customContent.currentSeason.toLowerCase(); }
            if ( this.customContent.currentWeekNumber != "" ){  currentWeekNumber = this.customContent.currentWeekNumber.toLowerCase(); }
          }
          constructCurrentWorkoutButton();
        });
      }
    );
  }
  
  function getPlans(){ 
    return $.ajax({
      url: "https://www.welllifewellness.com/plans", 
      data: {format:"json"}, 
      dataType: "json", 
      method: "GET"
    });
  }
  function getWorkouts(){  
    return $.ajax({
      url: "https://www.welllifewellness.com/workouts", 
      data: {format:"json"}, 
      dataType: "json", 
      method: "GET"
    });
  }

  var planId = $("#planId").val().toUpperCase();
  var clientPlan, clientWorkouts = [];
  var gender, level, clientFullName, currentSeason, currentWeekNumber;

  $(document).ready(function(){

    $.when(getPlans(), getWorkouts()).done(function(plans, workouts){
      //Client plan info
      $(plans[0].items).each(function(){
        if ( this.customContent.planId.toUpperCase() == planId ){
          clientPlan = this.customContent;
        }
      });
      //Client workouts
      $(workouts[0].items).each(function(){
        if (  
          this.customContent.gender.toUpperCase() == clientPlan.gender.toUpperCase() && 
          this.customContent.level.toUpperCase()  == clientPlan.level.toUpperCase() && 
          (this.customContent.planId.toUpperCase() == clientPlan.planId.toUpperCase() || this.customContent.planId.toUpperCase() == "")
        ){
          var newWorkout = {};
          newWorkout["planId"] = this.customContent.planId.toUpperCase();
          newWorkout["weekNumber"] = this.customContent.weekNumber;
          newWorkout["season"] = this.customContent.season.toUpperCase();
          newWorkout["gender"] = this.customContent.gender.toUpperCase();
          newWorkout["level"] = this.customContent.level.toUpperCase();
          newWorkout["content"] = this.body;

          var workoutExists = false;
          $(clientWorkouts).each(function(index){
            if (
              this["weekNumber"] == newWorkout["weekNumber"] &&
              this["season"] == newWorkout["season"] &&
              this["gender"] == newWorkout["gender"] &&
              this["level"] == newWorkout["level"] &&
              this["planId"] != "" 
            ){
              workoutExists = true;
            } else if (
              this["weekNumber"] == newWorkout["weekNumber"] &&
              this["season"] == newWorkout["season"] &&
              this["gender"] == newWorkout["gender"] &&
              this["level"] == newWorkout["level"] &&
              this["planId"] == "" &&
              newWorkout["planId"] != "" 
            ){
              clientWorkouts.splice(index, 1);
            } 
          })
          if (!workoutExists){
            clientWorkouts.push(newWorkout);
          }
        }
      });

      createSeasonMenus(clientWorkouts);
      addDropdownListeners();

      console.log(clientPlan);
      console.log(clientWorkouts);

    });

    getClientPlanInfo();

    addSideNavListeners();

    if (currentSeason != undefined && currentWeekNumber != undefined){
      addCurrentWeekListener();
    }

  });
</script>