<style>
  #page {
    min-height: 800px;
  }
  #contentContainer {
    padding-top: 20px;
  }
  #workoutTabs .nav-item {
    display: none;
  }

</style>

<input id="planId" name="planId" type="hidden" value="{collection.urlId}">

<ul id="workoutTabs" class="nav nav-tabs">
  <li id="currentWorkoutTab" class="nav-item">
    <a class="nav-link" href="#">This Week</a>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Off-Season<span class="caret"></span></a>
    <div class="dropdown-menu" id="offseasonMenu"></div>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Pre-Season<span class="caret"></span></a>
    <div class="dropdown-menu" id="preseasonMenu"></div>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">In-Season<span class="caret"></span></a>
    <div class="dropdown-menu" id="inseasonMenu"></div>
  </li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Post-Season<span class="caret"></span></a>
    <div class="dropdown-menu" id="postseasonMenu"></div>
  </li>
</ul>
<div id="contentContainer"></div>

<script type="text/javascript">

  // Load all images via Squarespace's Responsive ImageLoader
  function loadAllImages() {
    var images = document.querySelectorAll('img[data-src]' );
    for (var i = 0; i < images.length; i++) {
      ImageLoader.load(images[i], {load: true});
    }
  }

  function displayContent( title, content ){
    var headerElement = "<h1 class='text-align-center'><strong>" + title + "</strong></h1>";
    $("#contentContainer").html(headerElement + content);
    loadAllImages();
  };

  function populateSeasonMenus(){
    $(clientWorkouts).each(function(index){

      var customWeekNumber = index + 1;
      
      var link = $("<a>");
      link.addClass( "dropdown-item" );
      link.data( "workoutId",   index)

      if (this.isOffWeek){
        link.addClass( "disabled" );
        link.html( "Week " + customWeekNumber + " - OFF" );
      } else if (this.content == "") {
        link.addClass( "disabled" );
        link.html( "Week " + customWeekNumber );
      } else {
        link.attr( "href",  "#" );
        link.html( "Week " + customWeekNumber );
      }

      var seasonMenu;
      switch ( this.seasonNumber ) {
        case 1:
          seasonMenu = $("#offseasonMenu");
          break;
        case 2:
          seasonMenu = $("#preseasonMenu");
          break;
        case 3:
          seasonMenu = $("#inseasonMenu");
          break;
        case 4:
          seasonMenu = $("#postseasonMenu");
          break;
      }

      seasonMenu.append(link);
      $(seasonMenu).parent().show();

    });
  };

  function clearSideNavActiveLink(){
    $(".sectionLinkContainer").each(function(){
      $(this).removeClass("active-link");
    });
  };
  function clearDropdownActiveLink(){
    $(".dropdown-item").each(function(){
      $(this).removeClass("active");
    });
  };
  function clearTabActiveLink(){
    $(".nav-link").each(function(){
      $(this).removeClass("active");
    });
  };
  function clearActive(){
    clearSideNavActiveLink();
    clearDropdownActiveLink();
    clearTabActiveLink();
  };

  function addSideNavListeners(){

    $(".sectionLink").each(function(){
      $(this).click(function(event) {
        event.preventDefault();

        clearActive();
        var parentContainer = $(this).parent()[0];
        $(parentContainer).addClass("active-link");

        var sectionLinkSlug = $(this).data("href");
        var url = sectionLinkSlug;

        $.ajax({
          url: url, 
          data: {format:"json"}, 
          dataType: "json", 
          method: "GET"
        })
        .done(
          function(data){
            displayContent(data.collection.navigationTitle, data.mainContent);
          }
        );

      });
    });
  };

  function addCurrentWeekListener(){
    $("#currentWorkoutTab .nav-link").click(function(event){
      event.preventDefault();

      clearActive();
      $(this).addClass("active");

      $(clientWorkouts).each(function(index){
        if (this.seasonNumber == clientPlan.currentSeasonNumber && this.weekNumber == clientPlan.currentWeekNumber){
          displayContent("Week " + (index+1), this.content);
        }
      });
    })
  }

  function addWorkoutWeekListeners(){

    $("#workoutTabs .nav-item .dropdown-menu .dropdown-item:not(.disabled)").each(function(){

      $(this).click(function(event) {

        event.preventDefault(); 

        clearActive();
        $(this).addClass("active");
        $($($(this).parent()[0]).siblings(".nav-link.dropdown-toggle")[0]).addClass("active");

        var workoutIdClicked = $(this).data("workoutId");
        var workoutWeekNumber = workoutIdClicked + 1;
        
        displayContent("Week " + workoutWeekNumber, clientWorkouts[workoutIdClicked].content);

      });
    });
  };

  function getSeasonNumber( seasonPrefix ){
      switch ( seasonPrefix.toUpperCase() ) {
        case "OFF":
          return 1;
        case "PRE":
          return 2;
        case "IN":
          return 3;
        case "POST":
          return 4;
      }
  }
  
  function getPlans(){ 
    return $.ajax({
      url: "/plans", 
      data: {format:"json"}, 
      dataType: "json", 
      method: "GET"
    });
  }
  function getWorkouts(){  
    return $.ajax({
      url: "/workouts", 
      data: {format:"json"}, 
      dataType: "json", 
      method: "GET"
    });
  }

  var planId = $("#planId").val().toUpperCase();
  var clientPlan = {};
  var clientWorkouts = [];

  $(document).ready(function(){

    $.when(getPlans(), getWorkouts()).done(function(plans, workouts){
      //Client plan info
      $(plans[0].items).each(function(){
        if ( this.customContent.planId.toUpperCase() == planId ){
          clientPlan.planId = this.customContent.planId.toUpperCase();
          clientPlan.clientFullName = this.customContent.clientFullName;
          clientPlan.gender = this.customContent.gender.toUpperCase();
          clientPlan.level = this.customContent.level.toUpperCase();
          clientPlan.currentSeasonNumber = getSeasonNumber(this.customContent.currentSeason.toUpperCase());
          clientPlan.currentWeekNumber = this.customContent.currentWeekNumber;
        }
      });
      //Client workouts
      $(workouts[0].items).each(function(){
        if (  
          this.customContent.gender.toUpperCase() == clientPlan.gender.toUpperCase() && 
          this.customContent.level.toUpperCase()  == clientPlan.level.toUpperCase() && 
          (this.customContent.planId.toUpperCase() == clientPlan.planId.toUpperCase() || this.customContent.planId.toUpperCase() == "")
        ){
          var newWorkout = {};
          newWorkout["planId"] = this.customContent.planId.toUpperCase();
          newWorkout["weekNumber"] = this.customContent.weekNumber;
          newWorkout["seasonNumber"] = getSeasonNumber(this.customContent.season.toUpperCase());
          newWorkout["gender"] = this.customContent.gender.toUpperCase();
          newWorkout["level"] = this.customContent.level.toUpperCase();
          newWorkout["isOffWeek"] = this.customContent.isOffWeek;
          newWorkout["content"] = this.body;

          var workoutExists = false;
          $(clientWorkouts).each(function(index){
            if (
              this["weekNumber"] == newWorkout["weekNumber"] &&
              this["seasonNumber"] == newWorkout["seasonNumber"] &&
              this["gender"] == newWorkout["gender"] &&
              this["level"] == newWorkout["level"] &&
              this["planId"] != "" 
            ){
              workoutExists = true;
            } else if (
              this["weekNumber"] == newWorkout["weekNumber"] &&
              this["seasonNumber"] == newWorkout["seasonNumber"] &&
              this["gender"] == newWorkout["gender"] &&
              this["level"] == newWorkout["level"] &&
              this["planId"] == "" &&
              newWorkout["planId"] != "" 
            ){
              clientWorkouts.splice(index, 1);
            } 
          })
          if (!workoutExists){
            clientWorkouts.push(newWorkout);
          }
        }
      });
      clientWorkouts.sort(function(a, b) {
        return a.seasonNumber - b.seasonNumber  ||  a.weekNumber - b.weekNumber;
      });

      populateSeasonMenus();
      addWorkoutWeekListeners();
      addSideNavListeners();

      if (clientPlan.currentSeasonNumber != undefined && clientPlan.currentWeekNumber != undefined){
        addCurrentWeekListener();
        $("#currentWorkoutTab").show();
        $("#currentWorkoutTab a.nav-link").click();
      } else {
        $(".folder-nav ul li.sectionLinkContainer .sectionLink").first().click();
      }

    });



  });
</script>